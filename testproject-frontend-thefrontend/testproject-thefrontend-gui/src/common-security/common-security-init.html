<!--
  This file will be overwritten on every change of the model!
  This file was automatically generated by Barrakuda.
-->
<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../testproject-icons.html">

<link rel="import" href="../behaviors/testproject-form-behavior.html">
<link rel="import" href="../behaviors/testproject-error-behavior.html">
<link rel="import" href="../behaviors/nebula-polyglot-behavior.html">
<link rel="import" href="../behaviors/mixin.html">

<dom-module id="common-security-init">
    <script>
        /*
         * # Element zum initialen Abrufen der Rechte des aktuellen Users.
         * Muss in die index.html eingebunden werden, damit es von den anderen 
         * Security-Tags aus auffindbar ist.
         * 
         * @customElement
         * @polymer
         * @polymerBehavior Nebula.PolyglotBehavior
         * @appliesMixin TestprojectFormBehavior
         * @appliesMixin TestprojectErrorBehavior
         */
        class CommonSecurityInit extends mix(Polymer.Element).with(Nebula.PolyglotBehavior, TestprojectFormBehavior, TestprojectErrorBehavior) {
            static get is() {
                return 'common-security-init';
            }
            // properties
            static get properties() {
                return {
                	/**
                	 * Das '_domain' Property wird benötigt, um den richtigen Pfad 
                	 * zu den i18n Werten in der `locales.json` zu erzeugen. Es wird in jedem Element 
                	 * benötigt, welches das `Nebula.PolyglotBehavior` einbindet.
                	 *
                	 * Entgegen der Namensgebung kann hier auch 'view' angegeben werden, wenn in `entity`
                	 * eine View referenziert werden soll.
                	 *
                	 * Der vollständige Pfad setzt sich zusammen aus den Properties `lang`.`_domain`.`_entity`.`key`.
                	 */
                	_domain: {
                	    type: String,
                		value: 'testproject'
                	},
                	/*
                	 * Das '_entity' Property wird benötigt, um den richtigen Pfad 
                	 * zu den i18n Werten in der `locales.json` zu erzeugen. Es wird in jedem Element 
                	 * benötigt, welches das `Nebula.PolyglotBehavior` einbindet.
                	 *
                	 * Entgegen der Namensgebung können hier auch Views bzw. Custom Pfade angegeben werden.
                	 *
                	 * Der vollständige Pfad setzt sich zusammen aus den Properties `lang`.`_domain`.`_entity`.`key`.
                	 */
                	_entity: {
                	    type: String,
                	    value: 'security'
                	}
                	,
                    _permissions: {
                        type: Object,
                        value: [],
                        notify: true
                    },
                    //inherited from TestprojectFormBehaviour (kann man auch ohne das einen 
                    //observer registrieren?)
                    data: {
                        type: Object,
                        notify: true,
                        observer: '_dataUpdated'
                    },
                    noSecurity: {
                        type: Boolean,
                        value: false
                    },
                    url: {
                        type: String
                    }
                }
            }

            // methods
            connectedCallback() {
                super.connectedCallback();
                if (!this.noSecurity) {
                   this.loadUrl = this.url;
                }
            }

            checkPermissions(permissionToCheck) {
            	if (this.noSecurity) {
            		//noSecurity-Flag aktiv --> immer true zurückliefern
            		return true;
           		} else if (this._permissions.filter(e => e === permissionToCheck).length > 0) {
                    return true;
                }
//                console.log('checkPermissions: Permission ' + permissionToCheck + ' NOT found in list. Found: ' + this._permissions);
                return false;
            }

            getPermissions() {
                return this._permissions;
            }

            _dataUpdated() {
                this._permissions = this.data.permissions;
                window.dispatchEvent(new CustomEvent('permissionsReceived', {detail: {kicked: true}}));
            }

        }
        customElements.define(CommonSecurityInit.is, CommonSecurityInit);
    </script>
</dom-module>
