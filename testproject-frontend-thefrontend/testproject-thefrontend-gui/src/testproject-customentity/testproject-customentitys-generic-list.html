<!--
  This file will be overwritten on every change of the model!
  This file was automatically generated by Barrakuda.
-->
<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../../bower_components/paper-item/paper-item-body.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/nebula-i18n/nebula-i18n.html">
<link rel="import" href="../../bower_components/vaadin-material-theme/vaadin-grid.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid-column.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid-selection-column.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid-filter.html">

<link rel="import" href="../testproject-icons.html">
<link rel="import" href="../behaviors/testproject-list-behavior.html">
<link rel="import" href="../behaviors/testproject-error-behavior.html">
<link rel="import" href="../behaviors/nebula-polyglot-behavior.html">
<link rel="import" href="../behaviors/mixin.html">
<link rel="import" href="../common-libs/testproject-list-header.html">
<link rel="import" href="../common-libs/testproject-delete-dialogs.html">
<link rel="import" href="../testproject-customentity/testproject-customentity-create-dialog.html">
<link rel="import" href="../testproject-customentity/testproject-customentity-listelement.html">
<link rel="import" href="../common-security/common-security-check.html">

<dom-module id="testproject-customentitys-generic-list">
    <template>
      <style>
        section {
          width: 100%;
          height: 300px;
          @apply --layout-vertical;
        }
        section paper-dialog-scrollable {
          @apply --layout-flex;
        }
      </style>

      <!-- Routing Support -->
      <app-location
          route="{{route}}"
          url-space-regex="^[[rootPath]]"
          use-hash-as-path>
      </app-location>
      <app-route
          route="{{route}}"
          pattern="[[rootPath]]:page"
          data="{{routeData}}"
          active="{{active}}"
          tail="{{subroute}}">
      </app-route>

      <!--Security-->
      <common-security-check permission="thebackend_DELETE_CustomEntity" not-allowed="{{_noDeleteAllowed}}"></common-security-check>
      <common-security-check permission="thebackend_WRITE_CustomEntity" not-allowed="{{_noWriteAllowed}}"></common-security-check>


      <testproject-list-header
          id="testproject-list-header-search"
          placeholder-search="[[_setSearchText('search_placeholder')]]"
          placeholder-delete="[[$t('button_delete')]]"
          placeholder-new="[[$t('button_new')]]"
          placeholder-filter="[[$t('filter_placeholder')]]"
          placeholder-selection="[[$t('filter_items_selected')]]"
          search-filters="[[_localizedSearchFilters]]"
          all-filters="[[_localizedFilters]]"
          selected-filters = "{{_selectedFilters}}"
          search="{{_search}}"
          on-search="_searchData"
          on-filter-selection="_filterSelectionData"
          on-delete="_confirmDeleteSelected"
          on-new="_handleNew"
          disable-delete-button="[[_disableDeleteButton]]"
          hide-header="[[_hideSearchHeader(hideHeader)]]"
          hide-new-button="[[hideNew]]"
          hide-delete-button="[[hideDelete]]"
          hide-filter-button="[[hideFilter]]"
          hide-refresh-button
          disable-new-button="[[disableNew]]"
          show-results="[[showResults]]"
          results-text="[[resultsText]]"
          icon="[[icon]]"
          entity="[[_entity]]">
      </testproject-list-header>

      <testproject-list-header
          id="testproject-list-header-filter"
          placeholder-search="[[$t('filter_placeholder')]]"
		  placeholder-delete="[[$t('button_delete')]]"
          placeholder-new="[[$t('button_new')]]"
          placeholder-filter="[[$t('filter_placeholder')]]"
          placeholder-selection="[[$t('filter_items_selected')]]"
          search-filters="[[_localizedSearchFilters]]"
          all-filters="[[_localizedFilters]]"
          selected-filters = "{{_selectedFilters}}"
          search="{{_filterString}}"
          on-filter="_filterData"
          on-filter-selection="_filterSelectionData"
          on-delete="_confirmDeleteSelected"
          on-new="_handleNew"
          disable-delete-button="[[_disableDeleteButton]]"
          hide-header="[[_hideFilterHeader(hideHeader)]]"
          hide-new-button="[[hideNew]]"
          hide-delete-button="[[hideDelete]]"
          hide-filter-button="[[hideFilter]]"
          disable-filter-button="[[disableFilter]]"
          disable-new-button="[[disableNew]]"
          show-results="[[showResults]]"
          results-text="[[resultsText]]"
          icon="[[icon]]"
          entity="[[_entity]]">
      </testproject-list-header>


      <testproject-delete-dialogs
        id="deleteDialogs"
        header-text="[[$t('modal_delete_header')]]"
        multi-text="[[$t('modal_delete_text_multi')]]"
        single-text="[[$t('modal_delete_text_single')]]"
        button-yes-text="[[$t('modal_delete_button_yes')]]"
        button-no-text="[[$t('modal_delete_button_no')]]"
        delete-Info="[[_deleteInfo]]"
        on-delete="_deleteSelectedRows"
        on-cancel="_unsetTemporaryDeleteInfo"
      >
      </testproject-delete-dialogs>
      
      <testproject-customentity-create-dialog id="customentityCreateDialog" on-path-selected="_handleNewPath" lang="[[lang]]" resources="[[resources]]"></testproject-customentity-create-dialog>


      <template is="dom-if" if="[[_isOfType('list')]]">
        <section>
          <paper-dialog-scrollable>
              <paper-listbox>
                  <template is="dom-repeat" items="[[filteredData]]">
                      <template is="dom-if" if="[[_itemIsOfTypeOrNull(item, 'CustomEntity_')]]">
                        <testproject-customentity-listelement
                        show-icons="[[showIcons]]"
                        item="[[item]]"
                        id="[[item.id]]"
                        hide-delete="[[hideDelete]]"
                        hide-remove
                        hide-edit="[[hideEdit]]"
                        on-edit-row="_editRow"
                        on-delete-row="_confirmDeleteRowList"
                        filtered-data="[[filteredData]]"
                        resources="[[resources]]" lang="[[lang]]">
                        </testproject-customentity-listelement>
                      </template>
                  </template>
              </paper-listbox>
          </paper-dialog-scrollable>
        </section>
      </template>

     <template is="dom-if" if="[[_isOfType('table')]]">
     <!-- Für Suche über Lazy Loading:
     <vaadin-grid id="testproject-list" data-provider="[[dataProvider]]"  size="200" multi-sort="[[multiSort]]" selected-items="{{_selectedItems}}"> -->

     <vaadin-grid id="testproject-list" items="[[filteredData]]"  multi-sort="[[multiSort]]" selected-items="{{_selectedItems}}" theme="row-stripes">

        <vaadin-grid-selection-column auto-select>
        </vaadin-grid-selection-column>
        
        <template is="dom-if" if="[[detailRowActive]]">
          <vaadin-grid-column>
            <template class="header"></template>
            <template>
              <paper-icon-button icon="testproject-icons:chevron-down" on-tap="_toggleDetails"></paper-icon-button>              
            </template>
          </vaadin-grid-column>
        </template>

        <template is="dom-if" if="[[showIcons]]">
        <vaadin-grid-column width="50px" flex-grow="0" >
            <template class="header"></template>
            <template><iron-icon icon="testproject-icons:[[_entity]]" slot="item-icon"></iron-icon></template>
        </vaadin-grid-column>
        </template>

        <vaadin-grid-column width="50px" flex-grow="0" >
          <template class="header">#</template>
          <template>[[_rowNumber(index)]]</template>
        </vaadin-grid-column>

        <vaadin-grid-column hidden="[[!_showColumn('id')]]">
          <template class="header">
            <vaadin-grid-sorter path="id">[[$t('id')]]</vaadin-grid-sorter>
          </template>
          <template>[[item.id]]</template>
        </vaadin-grid-column>

		<vaadin-grid-column hidden="[[!_showColumn('fistLevel.secondLevel.theSecondLevelText')]]">
		  <template class="header">
		    <vaadin-grid-sorter path="fistLevel.secondLevel.theSecondLevelText">[[$t('fistLevel.secondLevel.theSecondLevelText')]]</vaadin-grid-sorter>
		  </template>
		  <template>[[item.fistLevel.secondLevel.theSecondLevelText]]</template>
		</vaadin-grid-column>
		<vaadin-grid-column hidden="[[!_showColumn('name')]]">
		  <template class="header">
		    <vaadin-grid-sorter path="name">[[$t('name')]]</vaadin-grid-sorter>
		  </template>
		  <template>[[item.name]]</template>
		</vaadin-grid-column>
		<vaadin-grid-column hidden="[[!_showColumn('fistLevel.theFirstLevelText')]]">
		  <template class="header">
		    <vaadin-grid-sorter path="fistLevel.theFirstLevelText">[[$t('fistLevel.theFirstLevelText')]]</vaadin-grid-sorter>
		  </template>
		  <template>[[item.fistLevel.theFirstLevelText]]</template>
		</vaadin-grid-column>
		<vaadin-grid-column hidden="[[!_showColumn('fistLevel.secondLevel.thirdLevel.theThirdLevelText')]]">
		  <template class="header">
		    <vaadin-grid-sorter path="fistLevel.secondLevel.thirdLevel.theThirdLevelText">[[$t('fistLevel.secondLevel.thirdLevel.theThirdLevelText')]]</vaadin-grid-sorter>
		  </template>
		  <template>[[item.fistLevel.secondLevel.thirdLevel.theThirdLevelText]]</template>
		</vaadin-grid-column>
		<vaadin-grid-column hidden="[[!_showColumn('text')]]">
		  <template class="header">
		    <vaadin-grid-sorter path="text">[[$t('text')]]</vaadin-grid-sorter>
		  </template>
		  <template>[[item.text]]</template>
		</vaadin-grid-column>

        <vaadin-grid-column>
          <template>
            <paper-icon-button
              icon="testproject-icons:delete"
              id="[[item.id]]"
              hidden="[[hideDelete]]"
              on-click="_confirmDeleteRowTable">
            </paper-icon-button>
          </template>
        </vaadin-grid-column>

        <vaadin-grid-column>
          <template>
            <paper-icon-button
              icon="testproject-icons:mode-edit"
              id="[[item.id]]"
              hidden="[[hideEdit]]"
              on-click="_editRow">
            </paper-icon-button>
          </template>
        </vaadin-grid-column>
      </vaadin-grid>
    </template>

    </template>

    <script>
      /*
       * `testproject-customentitys-list` ist eine Liste zur Anzeige von 'CustomEntitys', die über die angegebene [url](#/elements/testproject-customentitys-list#property-url)
       * gesucht werden.
       *
       * Zur Suche können Suchbegriffe eingegeben werden, um die Anzahl der gefundenen Datensätze zu begrenzen. Diese Suchbegriffe können
       * auch als Standard für die Liste festgelegt werden.
       *
       * Die gefundenen Datensätze können sortiert, selektiert und gelöscht werden.
       *
       * Die Navigation auf die Forms [`<testproject-customentity-create-form>`](#/elements/testproject-customentity-create-form)
       * und [`<testproject-customentity-update-form>`](#/elements/testproject-customentity-update-form)
       * zur Neuanlage bzw. zum Editieren eines Datensatzes ist möglich.
       *
       * #### Beispiel:
       *
       *     <testproject-customentitys-list name=""
       *       url="http://localhost:39146/customEntitys"
       *       default-search='$t(fistLevel.secondLevel.theSecondLevelText):"42" $t(name):"test" $t(fistLevel.theFirstLevelText):"42" $t(fistLevel.secondLevel.thirdLevel.theThirdLevelText):"42" $t(text):"test" '
       *       route="{{subroute}}"
       *       edit-path="/customentitys-view/edit"
       *       create-path="/customentitys-view/create">
       *     </testproject-customentitys-list>
       *
       * @polymer
       * @customElement
       * @polymerBehavior Nebula.PolyglotBehavior
       * @appliesMixin TestprojectListBehavior
       * @appliesMixin TestprojectErrorBehavior
       *
       */
      class TestprojectCustomentitysGenericList extends mix(Polymer.Element).with(Nebula.PolyglotBehavior, TestprojectListBehavior, TestprojectErrorBehavior) {

        static get is() { return 'testproject-customentitys-generic-list'; }

        static get properties() {
          return {
          	/**
          	 * Das '_domain' Property wird benötigt, um den richtigen Pfad 
          	 * zu den i18n Werten in der `locales.json` zu erzeugen. Es wird in jedem Element 
          	 * benötigt, welches das `Nebula.PolyglotBehavior` einbindet.
          	 *
          	 * Entgegen der Namensgebung kann hier auch 'view' angegeben werden, wenn in `entity`
          	 * eine View referenziert werden soll.
          	 *
          	 * Der vollständige Pfad setzt sich zusammen aus den Properties `lang`.`_domain`.`_entity`.`key`.
          	 */
          	_domain: {
          	    type: String,
          		value: 'testproject'
          	},
          	/*
          	 * Das '_entity' Property wird benötigt, um den richtigen Pfad 
          	 * zu den i18n Werten in der `locales.json` zu erzeugen. Es wird in jedem Element 
          	 * benötigt, welches das `Nebula.PolyglotBehavior` einbindet.
          	 *
          	 * Entgegen der Namensgebung können hier auch Views bzw. Custom Pfade angegeben werden.
          	 *
          	 * Der vollständige Pfad setzt sich zusammen aus den Properties `lang`.`_domain`.`_entity`.`key`.
          	 */
          	_entity: {
          	    type: String,
          	    value: 'CustomEntity'
          	}
          }
        }

        connectedCallback() {
            super.connectedCallback();
            window.addEventListener(this._entity + 'Reload', this._reloadListener.bind(this));
        }

        // Observers
        /*
         * Wechselt auf die unter [`createPath`](#/elements/testproject-customentitys-list#property-createPath) angegebene Form.
         */
        _handleNew(event) {
          this.$.customentityCreateDialog.open();
        }
        
        /**
         * Navigiert auf das im Event enthaltenen Create Path. 
         */
        _handleNewPath(event) {
          var routePath = event.detail.path;
          this.set("route.path", routePath);
        }

        /*
         * Wechselt auf die unter [`editPath`](#/elements/testproject-customentitys-list#property-editPath) angegebene Form.
         */
        _editRow(event){
          let routePath;
          if (this.editPath) {
          	// fester editPath
            if (event.target.id) {
                //wenn der Event aus dem vaadin-grid getriggert wird, steht die Ziel-ID in event.target.id
                routePath = this.editPath+'/'+event.target.id;
            } else {
                //wenn der Event erneut aus dem *listelement geworfen wird, steht die Ziel-ID in event.detail.id
                routePath = this.editPath+'/'+event.detail.id;
            }
          } else if (this.editPaths) {
          	  // editPath abhängig vom Typ der Entity (Vererbung)
              let editPath = this.editPaths[event.detail.type];
              if (editPath) {
                  if(event.target.id) {
                      //wenn der Event aus dem vaadin-grid getriggert wird, steht die Ziel-ID in event.target.id
                      routePath = editPath+'/'+event.target.id;
                  } else {
                      //wenn der Event erneut aus dem *listelement geworfen wird, steht die Ziel-ID in event.detail.id
                      routePath = editPath+'/'+event.detail.id;
                  }
              } else {
                  console.warn('Cannot find editPath for Type ' + event.detail.type);
              }
          } else {
              console.warn('Neither editPath nor editPaths ist set. Cannot navigate!')
          }
          this.set("route.path", routePath);
        }

        _confirmDeleteRowTable(e) {
          // this is optional. If not implemented will only ask question (translated): Do you really want to delete this item?
          var index = this.filteredData.findIndex(item => item.id == e.target.id);
          var item = this.filteredData[index];
          this._deleteInfo = this.$t('modal_deleteinfo', {text: item.text, name: item.name, testGender: item.testGender});

          super._confirmDeleteRow(e);
        }

        _confirmDeleteRowList(e) {
          this._deleteInfo = e.detail.deleteInfo;
          super._confirmDeleteRow(e);
        }

        /*
         * Führt die Suche im Backend bei der unter [`url`](#/elements/testproject-customentitys-list#property-url) angegebenen URL aus.
         */
        _searchData(event) {
          this._search = event.target.search.toLowerCase();
          super._fetchData(this._search);
        }
        
        /** 1-basierte Zeilennumer anhand des Grid Index */
        _rowNumber(index) {
          return index + 1;
        }
        
        /*
         * Bereitet die Ausgabe der Einträge in der Liste
         * nach den Vorgaben in der locales Datei auf. Dies
         * ist notwendig, weil man im HTML Bereich Databinding
         * nicht schachteln kann.
         *
         * @param   item das anzuzeigende Element
         * @return  formatierter Text
         */
        _format(key, item) {
                var translatedItem =  this.translateItem(item, 
                	['testGender','fistLevel.secondLevel.thirdLevel.theGender'],
                	[],
                );
                
                return this.$t(key, {
                    "fistLevel.secondLevel.theSecondLevelText": this._safelyGet("", ["fistLevel", "secondLevel", "theSecondLevelText"], item),
                    "name": this._safelyGet("", ["name"], item),
                    "fistLevel.theFirstLevelText": this._safelyGet("", ["fistLevel", "theFirstLevelText"], item),
                    "fistLevel.secondLevel.thirdLevel.theThirdLevelText": this._safelyGet("", ["fistLevel", "secondLevel", "thirdLevel", "theThirdLevelText"], item),
                    "text": this._safelyGet("", ["text"], item),
                    "testGender": this._safelyGet("", ["testGender"], translatedItem),
                    "fistLevel.secondLevel.thirdLevel.theGender": this._safelyGet("", ["fistLevel", "secondLevel", "thirdLevel", "theGender"], translatedItem),
                });
        }
      }

      customElements.define(TestprojectCustomentitysGenericList.is, TestprojectCustomentitysGenericList);
    </script>

  </dom-module>
