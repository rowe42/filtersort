<!--
  This file will be overwritten on every change of the model!
  This file was automatically generated by Barrakuda.
-->
<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/paper-autocomplete/paper-autocomplete.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-item/paper-item-body.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/polymer/lib/elements/dom-if.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../../bower_components/paper-search/paper-search-bar.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
 
<link rel="import" href="../testproject-icons.html">
<link rel="import" href="../common-libs/testproject-delete-dialogs.html">
<link rel="import" href="../behaviors/testproject-form-behavior.html">
<link rel="import" href="../behaviors/testproject-error-behavior.html">
<link rel="import" href="../behaviors/nebula-polyglot-behavior.html">
<link rel="import" href="../behaviors/testproject-relation-behavior.html">
<link rel="import" href="../behaviors/mixin.html">

<link rel="import" href="testproject-customentity-create-form.html">

<link rel="import" href="../testproject-customentity/testproject-customentity-listelement.html">


<dom-module id="testproject-customentity-simple-relation">
    <template>
        <style include="iron-flex iron-flex-alignment">
            .testproject-customentity-create-dialog-form {
                @apply --testproject-customentity-create-dialog-form;
            }
            .flex-equal-justified {
                @apply --layout-horizontal;
                @apply --layout-justified;
                @apply --layout-end;
            }
            .flexchild {
                @apply --layout-flex;
                padding-left: 10px;
            }
        </style>
        
        <testproject-delete-dialogs
          id="deleteDialogs"
          header-text="[[$t('modal_delete_header')]]"
          multi-text="[[$t('modal_delete_text_multi')]]"
          single-text="[[$t('modal_delete_text_single')]]"
          button-yes-text="[[$t('modal_delete_button_yes')]]"
          button-no-text="[[$t('modal_delete_button_no')]]"
          delete-Info="[[_deleteInfo]]"
          on-delete="_deleteRow"
          on-cancel="_unsetTemporaryDeleteInfo"
          >
        </testproject-delete-dialogs>
        
        <paper-dialog>
            <h2>[[$t('onthefly_heading')]]</h2>
            <paper-dialog-scrollable>
                <iron-form id="iform">
                    <form class="testproject-customentity-create-dialog-form"  id="containingform">
                        <testproject-customentity-form id="customform" data="{{_dialogdata}}" 
                           resources="[[resources]]" lang="[[lang]]" lists="[[lists]]" auto-validate>
                        </testproject-customentity-form>
                    </form>
                </iron-form>
            </paper-dialog-scrollable>
            <div class="buttons">
                <paper-button dialog-dismiss on-tap="_resetDialog">
                    <iron-icon icon="testproject-icons:close-circle"></iron-icon>
                    [[$t('button_cancel')]]
                </paper-button>
                <paper-button dialog-confirm on-tap="_saveDialog">
                    <iron-icon icon="testproject-icons:save"></iron-icon>
                    [[$t('button_save')]]
                </paper-button>
            </div>
        </paper-dialog>
        
        <div class="flex-equal-justified">
          <div>
          <paper-dropdown-menu id="sort-choice"
            class="paperdropdown"
            label="[[$t('sorting')]]"
            searchable="true"
            horizontal-align="[[horizontalAlignFilter]]"
            disabled="[[readonly]]">
              <paper-listbox attr-for-selected="key" selected="{{_sortKey}}"
                slot="dropdown-content">
                  <paper-item key="none">Keine</paper-item>
                  <paper-item key="fistLevel.secondLevel.theSecondLevelTextDown">[[$t('fistLevel.secondLevel.theSecondLevelText')]]▼</paper-item>
                  <paper-item key="fistLevel.secondLevel.theSecondLevelTextUp">[[$t('fistLevel.secondLevel.theSecondLevelText')]]▲</paper-item>
                  <paper-item key="nameDown">[[$t('name')]]▼</paper-item>
                  <paper-item key="nameUp">[[$t('name')]]▲</paper-item>
                  <paper-item key="fistLevel.theFirstLevelTextDown">[[$t('fistLevel.theFirstLevelText')]]▼</paper-item>
                  <paper-item key="fistLevel.theFirstLevelTextUp">[[$t('fistLevel.theFirstLevelText')]]▲</paper-item>
                  <paper-item key="fistLevel.secondLevel.thirdLevel.theThirdLevelTextDown">[[$t('fistLevel.secondLevel.thirdLevel.theThirdLevelText')]]▼</paper-item>
                  <paper-item key="fistLevel.secondLevel.thirdLevel.theThirdLevelTextUp">[[$t('fistLevel.secondLevel.thirdLevel.theThirdLevelText')]]▲</paper-item>
                  <paper-item key="textDown">[[$t('text')]]▼</paper-item>
                  <paper-item key="textUp">[[$t('text')]]▲</paper-item>
              </paper-listbox>
          </paper-dropdown-menu>
          </div>
        
          <div class="flexchild">
          <paper-autocomplete disabled="[[readonly]]"
            label="[[relationLabel]]" text="{{autocompleteValue}}"
            source="[[source]]" remote-source="{{!preload}}" min-length="3">
            <paper-icon-button slot="prefix" prefix icon="testproject-icons:magnify"></paper-icon-button>
            <template is="dom-if" if="[[_new]]">
            	<template is="dom-if" if="[[!readonly]]">
                	<paper-icon-button slot="suffix" icon="testproject-icons:plus-box" on-tap="_showDialog"></paper-icon-button>
                </template>
            </template>
          </paper-autocomplete>
          </div>
        
          <div>
          <paper-search-bar
            id="search-bar"
            class="search"
            icon="search"
            placeholder="Filter"
            query="{{_filterString}}"
            hide-filter-button
            on-paper-search-clear="_resetFilter">
          </paper-search-bar>
          </div>
        </div>
        
        <paper-listbox>
          <template id="customEntityList" is="dom-repeat" items="[[_embeddedItems]]" sort="_sort" filter="_filter">
            <template is="dom-if" if="[[_itemIsOfTypeOrNull(item, 'CustomEntity_')]]">
          	  <testproject-customentity-listelement
          	    show-icons
          	    item="[[item]]"
          	    id="[[item.id]]"
          	    hide-delete="[[readonly]]"
          	    hide-edit
          	    single-line
          	    on-delete-row="_confirmDeleteRowList"
          	    on-remove-row="_removeItem"
          	    readonly="[[readonly]]"
          	    resources="[[resources]]" lang="[[lang]]">
          	  </testproject-customentity-listelement>
          	</template>
          </template> 
        </paper-listbox>
    </template>

    <script>
        /*
         * # Formular zum Erstellen einer Relation zu einem 'Customentity'.
         * `<testproject-customentity-simple-relation>` stellt ein Suchfeld zur Verfügung, 
         * über das man ein 'Customentity' selektieren und als Relation an eine 
         * vorhandenen Datenstruktur einfügen kann. 
         *
         * ## Anwendung in der Applikation
         * ```html
         * <link rel="import" href="[Pfad zu meinen Abhängigkeiten]/testproject-customentity/testproject-customentity-simple-relation.html">
         * ...
         * <testproject-customentity-simple-relation 
         *   data="{{data}}"
         *   source-url="[Quelle zu den Customentitys]"
         *   text-property="name"
         *   value-property="id"
         *   >
         * </testproject-customentity-simple-relation>
         * ...
         * ```
         * 
         * @customElement
         * @polymer
         * @polymerBehavior Nebula.PolyglotBehavior
         * @appliesMixin TestprojectRelationBehavior
         * @appliesMixin TestprojectFormBehavior
         * @appliesMixin TestprojectErrorBehavior
         *
         */
        class TestprojectCustomentitySimpleRelation extends mix(Polymer.Element).with(Nebula.PolyglotBehavior, TestprojectRelationBehavior, TestprojectFormBehavior, TestprojectErrorBehavior) {
            static get is() { return 'testproject-customentity-simple-relation'; }

            static get properties() {
                return {
                	/**
                	 * Das '_domain' Property wird benötigt, um den richtigen Pfad 
                	 * zu den i18n Werten in der `locales.json` zu erzeugen. Es wird in jedem Element 
                	 * benötigt, welches das `Nebula.PolyglotBehavior` einbindet.
                	 *
                	 * Entgegen der Namensgebung kann hier auch 'view' angegeben werden, wenn in `entity`
                	 * eine View referenziert werden soll.
                	 *
                	 * Der vollständige Pfad setzt sich zusammen aus den Properties `lang`.`_domain`.`_entity`.`key`.
                	 */
                	_domain: {
                	    type: String,
                		value: 'testproject'
                	},
                	/*
                	 * Das '_entity' Property wird benötigt, um den richtigen Pfad 
                	 * zu den i18n Werten in der `locales.json` zu erzeugen. Es wird in jedem Element 
                	 * benötigt, welches das `Nebula.PolyglotBehavior` einbindet.
                	 *
                	 * Entgegen der Namensgebung können hier auch Views bzw. Custom Pfade angegeben werden.
                	 *
                	 * Der vollständige Pfad setzt sich zusammen aus den Properties `lang`.`_domain`.`_entity`.`key`.
                	 */
                	_entity: {
                	    type: String,
                	    value: 'CustomEntity'
                	}
                	,
                	_sortKey: {
                	  type: String,
                	  observer:  '_render'
                	},
                	_filterString: {
                	  type: String,
                	  observer: '_render'
                	},
                    backendUrl:{
                        type: String
                    },
                    relationLabel: {
                    	type: String
                    },
                }
            }

            constructor() {
                super();
            }

            connectedCallback() {
                super.connectedCallback();
            }

            /*
             * Bereitet die Ausgabe der Relationen in der Liste 
             * nach den Vorgaben in der locales Datei auf. Dies
             * ist notwendig, weil man im HTML Bereich Databinding
             * nicht schachteln kann.
             * 
             * @param   item das anzuzeigende Element
             * @return  formatierter Text
             */
            _format(item) {
                var translatedItem =  this.translateItem(item, ['testGender'], []);
                return this.$t('relation_list', { text: item.text, name: item.name, fistLevel: item.fistLevel, testGender: translatedItem.testGender });
            }

            /*
             * Formatiert die Ausgaben für den Suggester vor. 
             * Wie die Ausgabe formatiert wird (welche Werte 
             * gezeigt werden), kann in der i18n Datei definiert 
             * werden.
             * 
             * @param   die jeweilige Entität
             * @return  den formatierten Text für den Suggester
             */
            _formatSuggester(item) {
                var translatedItem =  this.translateItem(item, ['testGender'], []);
                return this.$t('relation_suggest', { text: item.text, name: item.name, fistLevel: item.fistLevel, testGender: translatedItem.testGender });
            }
            
            _sort(a, b) {
                let x,y;
                switch (this._sortKey) {
                case 'fistLevel.secondLevel.theSecondLevelTextDown': {
                    x = a.fistLevel.secondLevel.theSecondLevelText.toLowerCase();
                    y = b.fistLevel.secondLevel.theSecondLevelText.toLowerCase();
                    break;
                };
                case 'fistLevel.secondLevel.theSecondLevelTextUp': {
                    x = b.fistLevel.secondLevel.theSecondLevelText.toLowerCase();
                    y = a.fistLevel.secondLevel.theSecondLevelText.toLowerCase();
                    break;
                };
                case 'nameDown': {
                    x = a.name.toLowerCase();
                    y = b.name.toLowerCase();
                    break;
                };
                case 'nameUp': {
                    x = b.name.toLowerCase();
                    y = a.name.toLowerCase();
                    break;
                };
                case 'fistLevel.theFirstLevelTextDown': {
                    x = a.fistLevel.theFirstLevelText.toLowerCase();
                    y = b.fistLevel.theFirstLevelText.toLowerCase();
                    break;
                };
                case 'fistLevel.theFirstLevelTextUp': {
                    x = b.fistLevel.theFirstLevelText.toLowerCase();
                    y = a.fistLevel.theFirstLevelText.toLowerCase();
                    break;
                };
                case 'fistLevel.secondLevel.thirdLevel.theThirdLevelTextDown': {
                    x = a.fistLevel.secondLevel.thirdLevel.theThirdLevelText.toLowerCase();
                    y = b.fistLevel.secondLevel.thirdLevel.theThirdLevelText.toLowerCase();
                    break;
                };
                case 'fistLevel.secondLevel.thirdLevel.theThirdLevelTextUp': {
                    x = b.fistLevel.secondLevel.thirdLevel.theThirdLevelText.toLowerCase();
                    y = a.fistLevel.secondLevel.thirdLevel.theThirdLevelText.toLowerCase();
                    break;
                };
                case 'textDown': {
                    x = a.text.toLowerCase();
                    y = b.text.toLowerCase();
                    break;
                };
                case 'textUp': {
                    x = b.text.toLowerCase();
                    y = a.text.toLowerCase();
                    break;
                };
                    default: {
                        return 0;
                    }
                }
                if (x === y) return 0;
                return x < y ? -1 : 1;
            }
            
            _render() {
                this.$.customEntityList.render();
            }
            
            _filter(item) {
                if (this._filterString === undefined) return true;
                let filterString = this._filterString.toLowerCase();
                if (!item) return false;
                if (// includes all attributes of the current entity, its super-class(es) and all
                // its potential child-classes, that are defined as `searchable`
                (item.text && item.text != null ? item.text.toLowerCase().includes(filterString) : false) ||
                (item.fistLevel.secondLevel.thirdLevel.theThirdLevelText && item.fistLevel.secondLevel.thirdLevel.theThirdLevelText != null ? item.fistLevel.secondLevel.thirdLevel.theThirdLevelText.toLowerCase().includes(filterString) : false) ||
                (item.fistLevel.theFirstLevelText && item.fistLevel.theFirstLevelText != null ? item.fistLevel.theFirstLevelText.toLowerCase().includes(filterString) : false) ||
                (item.name && item.name != null ? item.name.toLowerCase().includes(filterString) : false) ||
                (item.fistLevel.secondLevel.theSecondLevelText && item.fistLevel.secondLevel.theSecondLevelText != null ? item.fistLevel.secondLevel.theSecondLevelText.toLowerCase().includes(filterString) : false)
                )
                    return true;
                return false;
            }
        }

        customElements.define(TestprojectCustomentitySimpleRelation.is, TestprojectCustomentitySimpleRelation);
    </script>
</dom-module>
