<!--
  This file will be overwritten on every change of the model!
  This file was automatically generated by Barrakuda.
-->
<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="testproject-backend-version">
    <template>
        <style is="custom-style">

            .testproject-backend-version {
                @apply --testproject-backend-version;
            }

        </style>

        <span id="backend-version-[[name]]">
            <span id="[[name]]-name">[[name]]</span>@<span id="[[name]]-version">[[_version]]</span>
        </span>
    </template>
    <script>

        /*
         * Ruft den angegebenen Actuator /info Endpoint auf und gibt Name und aktuell deployte Version aus.
         * Feuert CustomEvent 'backend-version-resolved' wenn der Aufruf an den Endpoint erfolgreich war
         * und enthÃ¤lt als Event-Detail Backend-Name 'backend' und Version 'version'.
         *
         * @customElement
         * @polymer
         */
        class TestprojectBackendVersion extends Polymer.Element {
            static get is() {
                return 'testproject-backend-version';
            }

            static get properties() {
                return {
                    /*  URL zum Spring Boot Actuator /info Endpoint */    
                    infoUrl: {
                        type: String,
                        value: ""
                    },
                    /* Backend Name */
                    name: {
                        type: String
                    },
                    _version : {
                        type: String,
                        value: "unknown"
                    }
                }
            }

            connectedCallback() {
                super.connectedCallback();
                this.callInfoEndpoint(this.infoUrl, this);
            }

            callInfoEndpoint(infoUrl, target) {
                // prepare request
                var init = {
                    method: "GET",
                    mode: 'cors',
                    credentials: 'include'
                }
                var request = new Request(infoUrl, init);

                fetch(request)
                    .then(response => {
                        if (response.ok) {
                            return response.json();
                        } else {
                            console.log("Faulty backend-version /info response: " + response);
                        }
                    })
                    .then(infoJson => {
                        target._version = infoJson.build.version;
                        this.dispatchEvent(new CustomEvent('backend-version-resolved',
                             {
                                 detail: {
                                     backend: this.name,
                                     version: this._version
                                 }
                             }
                         ));
                    })
                    .catch(error => {
                        console.log(error);
                    });
                }
        }

        customElements.define(TestprojectBackendVersion.is, TestprojectBackendVersion);
    </script>
</dom-module>
