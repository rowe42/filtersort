<!--
  This file will be overwritten on every change of the model!
  This file was automatically generated by Barrakuda.
-->
<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/paper-autocomplete/paper-autocomplete.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-item/paper-item-body.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/polymer/lib/elements/dom-if.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../../bower_components/paper-search/paper-search-bar.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
 
<link rel="import" href="../testproject-icons.html">
<link rel="import" href="../common-libs/testproject-delete-dialogs.html">
<link rel="import" href="../behaviors/testproject-form-behavior.html">
<link rel="import" href="../behaviors/testproject-error-behavior.html">
<link rel="import" href="../behaviors/nebula-polyglot-behavior.html">
<link rel="import" href="../behaviors/testproject-relation-behavior.html">
<link rel="import" href="../behaviors/mixin.html">

<link rel="import" href="testproject-dateentity-create-form.html">

<link rel="import" href="../testproject-dateentity/testproject-dateentity-listelement.html">


<dom-module id="testproject-dateentity-simple-relation">
    <template>
        <style include="iron-flex iron-flex-alignment">
            .testproject-dateentity-create-dialog-form {
                @apply --testproject-dateentity-create-dialog-form;
            }
            .flex-equal-justified {
                @apply --layout-horizontal;
                @apply --layout-justified;
                @apply --layout-end;
            }
            .flexchild {
                @apply --layout-flex;
                padding-left: 10px;
            }
        </style>
        
        <testproject-delete-dialogs
          id="deleteDialogs"
          header-text="[[$t('modal_delete_header')]]"
          multi-text="[[$t('modal_delete_text_multi')]]"
          single-text="[[$t('modal_delete_text_single')]]"
          button-yes-text="[[$t('modal_delete_button_yes')]]"
          button-no-text="[[$t('modal_delete_button_no')]]"
          delete-Info="[[_deleteInfo]]"
          on-delete="_deleteRow"
          on-cancel="_unsetTemporaryDeleteInfo"
          >
        </testproject-delete-dialogs>
        
        <paper-dialog>
            <h2>[[$t('onthefly_heading')]]</h2>
            <paper-dialog-scrollable>
                <iron-form id="iform">
                    <form class="testproject-dateentity-create-dialog-form"  id="containingform">
                        <testproject-dateentity-form id="customform" data="{{_dialogdata}}" 
                           resources="[[resources]]" lang="[[lang]]" lists="[[lists]]" auto-validate>
                        </testproject-dateentity-form>
                    </form>
                </iron-form>
            </paper-dialog-scrollable>
            <div class="buttons">
                <paper-button dialog-dismiss on-tap="_resetDialog">
                    <iron-icon icon="testproject-icons:close-circle"></iron-icon>
                    [[$t('button_cancel')]]
                </paper-button>
                <paper-button dialog-confirm on-tap="_saveDialog">
                    <iron-icon icon="testproject-icons:save"></iron-icon>
                    [[$t('button_save')]]
                </paper-button>
            </div>
        </paper-dialog>
        
        <div class="flex-equal-justified">
          <div>
          <paper-dropdown-menu id="sort-choice"
            class="paperdropdown"
            label="[[$t('sorting')]]"
            searchable="true"
            horizontal-align="[[horizontalAlignFilter]]"
            disabled="[[readonly]]">
              <paper-listbox attr-for-selected="key" selected="{{_sortKey}}"
                slot="dropdown-content">
                  <paper-item key="none">Keine</paper-item>
                  <paper-item key="theDateTimeDown">[[$t('theDateTime')]]▼</paper-item>
                  <paper-item key="theDateTimeUp">[[$t('theDateTime')]]▲</paper-item>
                  <paper-item key="theDateDown">[[$t('theDate')]]▼</paper-item>
                  <paper-item key="theDateUp">[[$t('theDate')]]▲</paper-item>
                  <paper-item key="theTimeDown">[[$t('theTime')]]▼</paper-item>
                  <paper-item key="theTimeUp">[[$t('theTime')]]▲</paper-item>
              </paper-listbox>
          </paper-dropdown-menu>
          </div>
        
          <div class="flexchild">
          <paper-autocomplete disabled="[[readonly]]"
            label="[[relationLabel]]" text="{{autocompleteValue}}"
            source="[[source]]" remote-source="{{!preload}}" min-length="3">
            <paper-icon-button slot="prefix" prefix icon="testproject-icons:magnify"></paper-icon-button>
            <template is="dom-if" if="[[_new]]">
            	<template is="dom-if" if="[[!readonly]]">
                	<paper-icon-button slot="suffix" icon="testproject-icons:plus-box" on-tap="_showDialog"></paper-icon-button>
                </template>
            </template>
          </paper-autocomplete>
          </div>
        
          <div>
          <paper-search-bar
            id="search-bar"
            class="search"
            icon="search"
            placeholder="Filter"
            query="{{_filterString}}"
            hide-filter-button
            on-paper-search-clear="_resetFilter">
          </paper-search-bar>
          </div>
        </div>
        
        <paper-listbox>
          <template id="dateEntityList" is="dom-repeat" items="[[_embeddedItems]]" sort="_sort" filter="_filter">
            <template is="dom-if" if="[[_itemIsOfTypeOrNull(item, 'DateEntity_')]]">
          	  <testproject-dateentity-listelement
          	    show-icons
          	    item="[[item]]"
          	    id="[[item.id]]"
          	    hide-delete="[[readonly]]"
          	    hide-edit
          	    single-line
          	    on-delete-row="_confirmDeleteRowList"
          	    on-remove-row="_removeItem"
          	    readonly="[[readonly]]"
          	    resources="[[resources]]" lang="[[lang]]">
          	  </testproject-dateentity-listelement>
          	</template>
          </template> 
        </paper-listbox>
    </template>

    <script>
        /*
         * # Formular zum Erstellen einer Relation zu einem 'Dateentity'.
         * `<testproject-dateentity-simple-relation>` stellt ein Suchfeld zur Verfügung, 
         * über das man ein 'Dateentity' selektieren und als Relation an eine 
         * vorhandenen Datenstruktur einfügen kann. 
         *
         * ## Anwendung in der Applikation
         * ```html
         * <link rel="import" href="[Pfad zu meinen Abhängigkeiten]/testproject-dateentity/testproject-dateentity-simple-relation.html">
         * ...
         * <testproject-dateentity-simple-relation 
         *   data="{{data}}"
         *   source-url="[Quelle zu den Dateentitys]"
         *   text-property="name"
         *   value-property="id"
         *   >
         * </testproject-dateentity-simple-relation>
         * ...
         * ```
         * 
         * @customElement
         * @polymer
         * @polymerBehavior Nebula.PolyglotBehavior
         * @appliesMixin TestprojectRelationBehavior
         * @appliesMixin TestprojectFormBehavior
         * @appliesMixin TestprojectErrorBehavior
         *
         */
        class TestprojectDateentitySimpleRelation extends mix(Polymer.Element).with(Nebula.PolyglotBehavior, TestprojectRelationBehavior, TestprojectFormBehavior, TestprojectErrorBehavior) {
            static get is() { return 'testproject-dateentity-simple-relation'; }

            static get properties() {
                return {
                	/**
                	 * Das '_domain' Property wird benötigt, um den richtigen Pfad 
                	 * zu den i18n Werten in der `locales.json` zu erzeugen. Es wird in jedem Element 
                	 * benötigt, welches das `Nebula.PolyglotBehavior` einbindet.
                	 *
                	 * Entgegen der Namensgebung kann hier auch 'view' angegeben werden, wenn in `entity`
                	 * eine View referenziert werden soll.
                	 *
                	 * Der vollständige Pfad setzt sich zusammen aus den Properties `lang`.`_domain`.`_entity`.`key`.
                	 */
                	_domain: {
                	    type: String,
                		value: 'testproject'
                	},
                	/*
                	 * Das '_entity' Property wird benötigt, um den richtigen Pfad 
                	 * zu den i18n Werten in der `locales.json` zu erzeugen. Es wird in jedem Element 
                	 * benötigt, welches das `Nebula.PolyglotBehavior` einbindet.
                	 *
                	 * Entgegen der Namensgebung können hier auch Views bzw. Custom Pfade angegeben werden.
                	 *
                	 * Der vollständige Pfad setzt sich zusammen aus den Properties `lang`.`_domain`.`_entity`.`key`.
                	 */
                	_entity: {
                	    type: String,
                	    value: 'DateEntity'
                	}
                	,
                	_sortKey: {
                	  type: String,
                	  observer:  '_render'
                	},
                	_filterString: {
                	  type: String,
                	  observer: '_render'
                	},
                    backendUrl:{
                        type: String
                    },
                    relationLabel: {
                    	type: String
                    },
                }
            }

            constructor() {
                super();
            }

            connectedCallback() {
                super.connectedCallback();
            }

            /*
             * Bereitet die Ausgabe der Relationen in der Liste 
             * nach den Vorgaben in der locales Datei auf. Dies
             * ist notwendig, weil man im HTML Bereich Databinding
             * nicht schachteln kann.
             * 
             * @param   item das anzuzeigende Element
             * @return  formatierter Text
             */
            _format(item) {
                var translatedItem =  this.translateItem(item, [], []);
                return this.$t('relation_list', { theDate: item.theDate, theDateTime: item.theDateTime, theTime: item.theTime });
            }

            /*
             * Formatiert die Ausgaben für den Suggester vor. 
             * Wie die Ausgabe formatiert wird (welche Werte 
             * gezeigt werden), kann in der i18n Datei definiert 
             * werden.
             * 
             * @param   die jeweilige Entität
             * @return  den formatierten Text für den Suggester
             */
            _formatSuggester(item) {
                var translatedItem =  this.translateItem(item, [], []);
                return this.$t('relation_suggest', { theDate: item.theDate, theDateTime: item.theDateTime, theTime: item.theTime });
            }
            
            _sort(a, b) {
                let x,y;
                switch (this._sortKey) {
                case 'theDateTimeDown': {
                    x = a.theDateTime.toLowerCase();
                    y = b.theDateTime.toLowerCase();
                    break;
                };
                case 'theDateTimeUp': {
                    x = b.theDateTime.toLowerCase();
                    y = a.theDateTime.toLowerCase();
                    break;
                };
                case 'theDateDown': {
                    x = a.theDate.toLowerCase();
                    y = b.theDate.toLowerCase();
                    break;
                };
                case 'theDateUp': {
                    x = b.theDate.toLowerCase();
                    y = a.theDate.toLowerCase();
                    break;
                };
                case 'theTimeDown': {
                    x = a.theTime.toLowerCase();
                    y = b.theTime.toLowerCase();
                    break;
                };
                case 'theTimeUp': {
                    x = b.theTime.toLowerCase();
                    y = a.theTime.toLowerCase();
                    break;
                };
                    default: {
                        return 0;
                    }
                }
                if (x === y) return 0;
                return x < y ? -1 : 1;
            }
            
            _render() {
                this.$.dateEntityList.render();
            }
            
            _filter(item) {
                if (this._filterString === undefined) return true;
                let filterString = this._filterString.toLowerCase();
                if (!item) return false;
                if (// includes all attributes of the current entity, its super-class(es) and all
                // its potential child-classes, that are defined as `searchable`
                (item.theTime && item.theTime != null ? item.theTime.toString().toLowerCase().includes(filterString) : false) ||
                (item.theDateTime && item.theDateTime != null ? item.theDateTime.toString().toLowerCase().includes(filterString) : false) ||
                (item.theDate && item.theDate != null ? item.theDate.toString().toLowerCase().includes(filterString) : false)
                )
                    return true;
                return false;
            }
        }

        customElements.define(TestprojectDateentitySimpleRelation.is, TestprojectDateentitySimpleRelation);
    </script>
</dom-module>
