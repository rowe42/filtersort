<!--
  This file will NOT be overwritten by Barrakuda.
  This file was automatically generated by Barrakuda.
-->
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">

    <title>backend-version tests</title>

    <script src="../bower_components/webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../bower_components/web-component-tester/browser.js"></script>

    <!-- Import the element to test -->
    <link rel="import" href="../src/common-libs/testproject-backend-version.html">

  </head>
  <body>
      <test-fixture id="no-backend-reachable">
        <template>
          <testproject-backend-version name="unreachable-backend" info-url="/will-not-respond"></testproject-backend-version>
        </template>
      </test-fixture>
      <test-fixture id="backend-reachable">
        <template>
          <testproject-backend-version name="reachable-backend" info-url="/will-respond"></testproject-backend-version>
        </template>
      </test-fixture>
      <script>
          <!-- Test uses Sinon to stub/mock the request made to the backend via Fetch-API -->
          describe('testproject-backend-version tests', function() {
              var noBackendReachable, backendReachable;
      
              beforeEach(function() {
                  // stub fetch api
                  sinon.stub(window, 'fetch');
              });
      
              afterEach(function(){
                  // restore fetch api
                  window.fetch.restore();
              });
              
              describe('stubbing info call with 404 response', function() {
                  beforeEach(() => {
                      console.log("mock response");
                      var response = new Response('', {
                              status: 404,
                              headers: {
                                  'Content-type': 'application/json'
                              }
                      });
                      window.fetch.returns(Promise.resolve(response));
                  });
      
                  it('version should be unknown', function() {
                      noBackendReachable = fixture('no-backend-reachable');
                      var spanName = noBackendReachable.shadowRoot.querySelector('#unreachable-backend-name');
                      var spanVersion = noBackendReachable.shadowRoot.querySelector('#unreachable-backend-version');
                      assert.equal(spanName.innerText, "unreachable-backend");
                      assert.equal(spanVersion.innerText, "unknown");
                  });
              });
      
              describe('stubbing /info call with good response', function() {
                  beforeEach(() => {
                      var response2 = new Response('{"build": {"version": "1.0.0"}}', {
                          status: 200,
                          headers: {
                              'Content-type': 'application/json'
                          }
                      });
                      window.fetch.returns(Promise.resolve(response2));
                  });
      
                  it('the custom event should fire', function(done) {
                      backendReachable = fixture('backend-reachable');
                      backendReachable.addEventListener('backend-version-resolved', function(event){
                          // check the event detail
                          assert.equal(event.detail.backend, "reachable-backend");
                          assert.equal(event.detail.version, "1.0.0");
                          done();
                      });
                  });
      
                  it('the dom should display the version', function(done) {
                      backendReachable = fixture('backend-reachable');
                      backendReachable.addEventListener('backend-version-resolved', function(event){
                          var spanName = backendReachable.shadowRoot.querySelector('#reachable-backend-name');
                          var spanVersion = backendReachable.shadowRoot.querySelector('#reachable-backend-version');
                          // check the dom
                          assert.equal(spanName.innerText, "reachable-backend");
                          assert.equal(spanVersion.innerText, "1.0.0");
                          done();
                      });
                  });
              });
          });
      </script>
  </body>
</html>
<!doctype html>
